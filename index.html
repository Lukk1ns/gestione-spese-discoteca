<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAGAMENTI TOTALI PAPI üòàüí∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, #ff6b6b, #ff0000);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .subtitle {
            color: #888;
            font-size: 1.1em;
        }

        /* Sezione Situazione Conto */
        .account-status-section {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid #f39c12;
            box-shadow: 0 10px 30px rgba(243, 156, 18, 0.2);
        }

        .account-status-title {
            font-size: 1.8em;
            color: #f39c12;
            margin-bottom: 20px;
            text-align: center;
        }

        .account-status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .account-card {
            background: #2d2d2d;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .account-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .account-label {
            color: #888;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .account-amount {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .account-amount.cash {
            color: #2ecc71;
        }

        .account-amount.cash.negative {
            color: #e74c3c;
        }

        .account-amount.bank {
            color: #3498db;
        }

        .account-amount.bank.negative {
            color: #e74c3c;
        }

        .account-amount.total {
            color: #f39c12;
        }

        .account-amount.total.negative {
            color: #e74c3c;
        }

        .pending-payments {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 1.1em;
        }

        .account-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn-gold {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-gold:hover {
            background: linear-gradient(135deg, #e67e22, #d68910);
            transform: translateY(-2px);
        }

        .income-input-section {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .income-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .income-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .income-input-group label {
            color: #888;
            font-size: 0.9em;
        }

        .income-input-group input, .income-input-group select {
            background: #1a1a1a;
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b, #ff0000);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.3);
        }

        .btn-secondary {
            background: #2d2d2d;
            color: white;
            border: 1px solid #444;
        }

        .btn-secondary:hover {
            background: #3d3d3d;
        }

        .btn-archive {
            background: #6c5ce7;
            color: white;
        }

        .btn-archive:hover {
            background: #5f3dc4;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #00b894;
            color: white;
        }

        .btn-success:hover {
            background: #00a383;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
            padding: 6px 12px;
            font-size: 14px;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .week-card {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            border: 1px solid #333;
            transition: all 0.3s ease;
        }

        .week-card.archived {
            opacity: 0.8;
            border-color: #6c5ce7;
        }

        .week-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 0, 0, 0.1);
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #333;
        }

        .week-date {
            font-size: 1.3em;
            color: #ff6b6b;
        }

        .archived-badge {
            background: #6c5ce7;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .expense-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .expense-item {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
            position: relative;
        }

        .expense-item:hover {
            background: #3d3d3d;
            transform: scale(1.02);
        }

        .payment-status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .payment-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .payment-status-label {
            font-size: 0.8em;
            color: #888;
        }

        .expense-label {
            font-weight: 500;
            color: #ccc;
            margin-bottom: 10px;
            display: block;
        }

        .expense-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .expense-input {
            width: 100%;
            background: #1a1a1a;
            border: 1px solid #444;
            color: white;
            padding: 8px;
            border-radius: 5px;
            text-align: right;
            font-size: 16px;
        }

        .expense-input:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 5px rgba(255, 107, 107, 0.3);
        }

        .expense-input.paid {
            opacity: 0.6;
            background: #1d3d1d;
        }

        .payment-label {
            font-size: 0.9em;
            color: #888;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .total-section {
            background: linear-gradient(135deg, #2d2d2d, #1a1a1a);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .total-amount {
            font-size: 2em;
            color: #ff6b6b;
            font-weight: bold;
        }

        .payment-totals {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-top: 15px;
        }

        .payment-total-item {
            text-align: center;
        }

        .payment-total-label {
            color: #888;
            font-size: 0.9em;
        }

        .payment-total-value {
            color: #4ecdc4;
            font-size: 1.2em;
            font-weight: bold;
        }

        .archive-section {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 30px;
            margin-top: 40px;
            border: 2px solid #6c5ce7;
        }

        .archive-title {
            font-size: 1.5em;
            color: #6c5ce7;
            margin-bottom: 20px;
            text-align: center;
        }

        .archived-weeks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .archived-week-card {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #444;
        }

        .archived-week-card:hover {
            background: #3d3d3d;
            transform: scale(1.02);
            border-color: #6c5ce7;
        }

        .payments-tracker-section {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 30px;
            margin-top: 40px;
            border: 2px solid #00b894;
        }

        .payments-tracker-title {
            font-size: 1.5em;
            color: #00b894;
            margin-bottom: 20px;
            text-align: center;
        }

        .payment-track-item {
            background: #2d2d2d;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .payment-track-item:hover {
            background: #3d3d3d;
        }

        .payment-track-item.completed {
            opacity: 0.6;
            background: #1d3d1d;
        }

        .payment-track-info {
            flex: 1;
        }

        .payment-track-category {
            font-weight: bold;
            color: #ff6b6b;
        }

        .payment-track-details {
            font-size: 0.9em;
            color: #888;
            margin-top: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 30px;
            border-radius: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 30px;
            cursor: pointer;
            color: #888;
        }

        .close-btn:hover {
            color: #ff6b6b;
        }

        .chart-container {
            margin: 20px 0;
            height: 400px;
            background: #0a0a0a;
            border-radius: 10px;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-title {
            color: #888;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.5em;
            color: #ff6b6b;
            font-weight: bold;
        }

        .custom-expense {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .custom-expense input {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #444;
            color: white;
            padding: 10px;
            border-radius: 5px;
        }

        .week-selector {
            display: flex;
            gap: 10px;
            align-items: center;
            margin: 20px 0;
        }

        .week-selector select {
            background: #2d2d2d;
            color: white;
            border: 1px solid #444;
            padding: 10px;
            border-radius: 5px;
            font-size: 16px;
        }

        .transaction-history {
            background: #2d2d2d;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            padding: 10px;
            border-bottom: 1px solid #444;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-date {
            font-size: 0.8em;
            color: #888;
        }

        .transaction-amount {
            font-weight: bold;
        }

        .transaction-amount.positive {
            color: #2ecc71;
        }

        .transaction-amount.negative {
            color: #e74c3c;
        }

        .transaction-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .expense-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8em;
            }

            .payment-totals {
                flex-direction: column;
                gap: 10px;
            }

            .expense-inputs {
                grid-template-columns: 1fr;
            }

            .week-selector {
                flex-direction: column;
            }

            .account-status-grid {
                grid-template-columns: 1fr;
            }
        }

        @media print {
            body {
                background: white;
                color: black;
            }
            
            .btn, .controls {
                display: none;
            }
            
            .week-card {
                background: white;
                border: 1px solid #ddd;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PAGAMENTI TOTALI PAPI üòàüí∞</h1>
            <p class="subtitle">Gestione Pagamenti Settimanali Discoteca</p>
        </header>

        <!-- Sezione Situazione Conto -->
        <div class="account-status-section">
            <h2 class="account-status-title">üí∞ SITUAZIONE CONTO GENERALE</h2>
            <div class="account-status-grid">
                <div class="account-card">
                    <div class="account-label">üíµ Contanti</div>
                    <div class="account-amount cash" id="cashBalance">‚Ç¨ 0.00</div>
                </div>
                <div class="account-card">
                    <div class="account-label">üè¶ Banca</div>
                    <div class="account-amount bank" id="bankBalance">‚Ç¨ 0.00</div>
                </div>
                <div class="account-card">
                    <div class="account-label">üí∞ Totale Disponibile</div>
                    <div class="account-amount total" id="totalBalance">‚Ç¨ 0.00</div>
                    <div class="pending-payments" id="pendingPayments" style="display: none;">
                        Pagamenti in sospeso: <span id="pendingAmount">‚Ç¨ 0.00</span>
                    </div>
                </div>
            </div>
            
            <div class="account-actions">
                <button class="btn btn-gold" onclick="showIncomeModal()">
                    ‚ûï Registra Incasso
                </button>
                <button class="btn btn-gold" onclick="showInitialBalanceModal()">
                    ‚öôÔ∏è Imposta Saldo Iniziale
                </button>
                <button class="btn btn-secondary" onclick="showTransactionHistory()">
                    üìã Storico Movimenti
                </button>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="showAddWeekModal()">
                ‚ûï Nuova Settimana
            </button>
            <button class="btn btn-secondary" onclick="showStatistics()">
                üìä Statistiche
            </button>
            <button class="btn btn-secondary" onclick="showCategoryAnalysis()">
                üìà Analisi per Categoria
            </button>
            <button class="btn btn-secondary" onclick="showPaymentMethodStats()">
                üí≥ Analisi Metodi Pagamento
            </button>
            <button class="btn btn-secondary" onclick="exportAllToPDF()">
                üìÑ Esporta Tutto in PDF
            </button>
        </div>

        <div id="weeksContainer"></div>

        <div class="payments-tracker-section" id="paymentsTrackerSection" style="display: none;">
            <h2 class="payments-tracker-title">‚úÖ Tracciamento Pagamenti Archiviati</h2>
            <div id="paymentsTrackerContainer"></div>
        </div>

        <div class="archive-section" id="archiveSection" style="display: none;">
            <h2 class="archive-title">üìÅ Settimane Archiviate</h2>
            <div class="archived-weeks-grid" id="archivedWeeksContainer"></div>
        </div>
    </div>

    <!-- Modal per aggiungere settimana -->
    <div id="addWeekModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('addWeekModal')">&times;</span>
            <h2 style="margin-bottom: 20px; color: #ff6b6b;">‚ûï Aggiungi Nuova Settimana</h2>
            <div class="week-selector">
                <label>Settimana:</label>
                <select id="weekNumber">
                    <option value="1">Settimana 1</option>
                    <option value="2">Settimana 2</option>
                    <option value="3">Settimana 3</option>
                    <option value="4">Settimana 4</option>
                    <option value="5">Settimana 5</option>
                </select>
                <label>Mese:</label>
                <select id="monthSelect">
                    <option value="0">Gennaio</option>
                    <option value="1">Febbraio</option>
                    <option value="2">Marzo</option>
                    <option value="3">Aprile</option>
                    <option value="4">Maggio</option>
                    <option value="5">Giugno</option>
                    <option value="6">Luglio</option>
                    <option value="7">Agosto</option>
                    <option value="8">Settembre</option>
                    <option value="9">Ottobre</option>
                    <option value="10">Novembre</option>
                    <option value="11">Dicembre</option>
                </select>
                <label>Anno:</label>
                <select id="yearSelect">
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
            </div>
            <button class="btn btn-primary" style="margin-top: 20px; width: 100%;" onclick="confirmAddWeek()">
                Crea Settimana
            </button>
        </div>
    </div>

    <!-- Modal per registrare incassi -->
    <div id="incomeModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('incomeModal')">&times;</span>
            <h2 style="margin-bottom: 20px; color: #f39c12;">‚ûï Registra Incasso</h2>
            <div class="income-inputs">
                <div class="income-input-group">
                    <label>üìÖ Data Incasso</label>
                    <input type="date" id="incomeDate" value="">
                </div>
                <div class="income-input-group">
                    <label>üíµ Incasso Contanti</label>
                    <input type="number" id="incomeCash" placeholder="0.00">
                </div>
                <div class="income-input-group">
                    <label>üè¶ Incasso Bonifico</label>
                    <input type="number" id="incomeBank" placeholder="0.00">
                </div>
                <div class="income-input-group">
                    <label>üìù Descrizione</label>
                    <input type="text" id="incomeDescription" placeholder="Es. Incasso serata">
                </div>
            </div>
            <button class="btn btn-gold" style="width: 100%; margin-top: 20px;" onclick="confirmIncome()">
                Conferma Incasso
            </button>
        </div>
    </div>

    <!-- Modal per impostare saldo iniziale -->
    <div id="initialBalanceModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('initialBalanceModal')">&times;</span>
            <h2 style="margin-bottom: 20px; color: #f39c12;">‚öôÔ∏è Imposta Saldo Iniziale</h2>
            <div class="income-inputs">
                <div class="income-input-group">
                    <label>üíµ Saldo Contanti</label>
                    <input type="number" id="initialCash" placeholder="0.00">
                </div>
                <div class="income-input-group">
                    <label>üè¶ Saldo Banca</label>
                    <input type="number" id="initialBank" placeholder="0.00">
                </div>
            </div>
            <div style="margin-top: 20px; padding: 15px; background: #2d2d2d; border-radius: 10px;">
                <h3 style="color: #ff6b6b; margin-bottom: 10px;">‚ö†Ô∏è Attenzione</h3>
                <p style="color: #888; font-size: 0.9em;">Questa operazione sovrascriver√† i saldi attuali. Usa questa funzione solo per l'impostazione iniziale o per correzioni importanti.</p>
            </div>
            <button class="btn btn-gold" style="width: 100%; margin-top: 20px;" onclick="confirmInitialBalance()">
                Imposta Saldo
            </button>
        </div>
    </div>

    <!-- Modal per storico transazioni -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('transactionModal')">&times;</span>
            <h2 style="margin-bottom: 20px; color: #f39c12;">üìã Storico Movimenti</h2>
            <div id="transactionContent"></div>
        </div>
    </div>

    <!-- Modal per statistiche -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('statsModal')">&times;</span>
            <h2 style="margin-bottom: 20px; color: #ff6b6b;">üìä Statistiche Generali</h2>
            <div id="statsContent"></div>
        </div>
    </div>

    <!-- Modal per analisi categorie -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('categoryModal')">&times;</span>
            <h2 style="margin-bottom: 20px; color: #ff6b6b;">üìà Analisi per Categoria</h2>
            <div id="categoryContent"></div>
        </div>
    </div>

    <!-- Modal per analisi metodi di pagamento -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('paymentModal')">&times;</span>
            <h2 style="margin-bottom: 20px; color: #ff6b6b;">üí≥ Analisi Metodi di Pagamento</h2>
            <div id="paymentContent"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        // Categorie predefinite
        const defaultCategories = [
            'PERSONALE', 'SICUREZZA',
            'AFFITTO', 'CORRENTE', 'SIAE', 'CRISTIAN', 
            'LUKA', 'TASSE', 'FORNITORE', 'TONI', 'CARTA', 
            'BHREMA', 'FRUTTA'
        ];

        // Dati memorizzati
        let weeksData = JSON.parse(localStorage.getItem('papiWeeksData')) || [];
        let archivedWeeks = JSON.parse(localStorage.getItem('papiArchivedWeeks')) || [];
        let weekIdCounter = parseInt(localStorage.getItem('papiWeekIdCounter')) || 0;
        let paymentStatus = JSON.parse(localStorage.getItem('papiPaymentStatus')) || {};
        let accountBalance = JSON.parse(localStorage.getItem('papiAccountBalance')) || { cash: 0, bank: 0 };
        let transactions = JSON.parse(localStorage.getItem('papiTransactions')) || [];
        let expensePaymentStatus = JSON.parse(localStorage.getItem('papiExpensePaymentStatus')) || {};
        let charts = {};

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            // Imposta mese e anno correnti
            const now = new Date();
            document.getElementById('monthSelect').value = now.getMonth();
            document.getElementById('yearSelect').value = now.getFullYear();
            
            // Imposta data corrente nel campo data incasso
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('incomeDate').value = today;
            
            updateAccountDisplay();
            renderWeeks();
            renderArchivedWeeks();
            renderPaymentsTracker();
        });

        function saveData() {
            localStorage.setItem('papiWeeksData', JSON.stringify(weeksData));
            localStorage.setItem('papiArchivedWeeks', JSON.stringify(archivedWeeks));
            localStorage.setItem('papiWeekIdCounter', weekIdCounter.toString());
            localStorage.setItem('papiPaymentStatus', JSON.stringify(paymentStatus));
            localStorage.setItem('papiAccountBalance', JSON.stringify(accountBalance));
            localStorage.setItem('papiTransactions', JSON.stringify(transactions));
            localStorage.setItem('papiExpensePaymentStatus', JSON.stringify(expensePaymentStatus));
        }

        function updateAccountDisplay() {
            const cashEl = document.getElementById('cashBalance');
            const bankEl = document.getElementById('bankBalance');
            const totalEl = document.getElementById('totalBalance');
            
            // Aggiungi classe negative se il saldo √® negativo
            if (accountBalance.cash < 0) {
                cashEl.classList.add('negative');
            } else {
                cashEl.classList.remove('negative');
            }
            
            if (accountBalance.bank < 0) {
                bankEl.classList.add('negative');
            } else {
                bankEl.classList.remove('negative');
            }
            
            const total = accountBalance.cash + accountBalance.bank;
            if (total < 0) {
                totalEl.classList.add('negative');
            } else {
                totalEl.classList.remove('negative');
            }
            
            cashEl.textContent = `‚Ç¨ ${accountBalance.cash.toFixed(2)}`;
            bankEl.textContent = `‚Ç¨ ${accountBalance.bank.toFixed(2)}`;
            totalEl.textContent = `‚Ç¨ ${total.toFixed(2)}`;
            
            // Calcola pagamenti pendenti
            const pendingTotal = calculatePendingPayments();
            if (pendingTotal > 0) {
                document.getElementById('pendingPayments').style.display = 'block';
                document.getElementById('pendingAmount').textContent = `‚Ç¨ ${pendingTotal.toFixed(2)}`;
            } else {
                document.getElementById('pendingPayments').style.display = 'none';
            }
        }

        function calculatePendingPayments() {
            let total = 0;
            weeksData.forEach(week => {
                Object.entries(week.expenses).forEach(([cat, data]) => {
                    const key = `${week.id}-${cat}`;
                    if (!expensePaymentStatus[`${key}-cash`] && data.cash > 0) {
                        total += data.cash;
                    }
                    if (!expensePaymentStatus[`${key}-bank`] && data.bank > 0) {
                        total += data.bank;
                    }
                });
                Object.entries(week.customExpenses).forEach(([cat, data]) => {
                    const key = `${week.id}-custom-${cat}`;
                    if (!expensePaymentStatus[`${key}-cash`] && data.cash > 0) {
                        total += data.cash;
                    }
                    if (!expensePaymentStatus[`${key}-bank`] && data.bank > 0) {
                        total += data.bank;
                    }
                });
            });
            return total;
        }

        function showIncomeModal() {
            // Imposta data corrente come default
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('incomeDate').value = today;
            document.getElementById('incomeModal').style.display = 'flex';
        }

        function confirmIncome() {
            const incomeDate = document.getElementById('incomeDate').value;
            const cashAmount = parseFloat(document.getElementById('incomeCash').value) || 0;
            const bankAmount = parseFloat(document.getElementById('incomeBank').value) || 0;
            const description = document.getElementById('incomeDescription').value || 'Incasso';
            
            if (cashAmount === 0 && bankAmount === 0) {
                alert('Inserisci almeno un importo!');
                return;
            }
            
            if (!incomeDate) {
                alert('Seleziona una data!');
                return;
            }
            
            // Aggiorna saldi
            accountBalance.cash += cashAmount;
            accountBalance.bank += bankAmount;
            
            // Registra transazione con la data specificata
            transactions.push({
                id: Date.now(), // Aggiungiamo un ID univoco
                date: new Date(incomeDate + 'T12:00:00').toISOString(),
                type: 'income',
                description: description,
                cash: cashAmount,
                bank: bankAmount,
                total: cashAmount + bankAmount
            });
            
            saveData();
            updateAccountDisplay();
            closeModal('incomeModal');
            
            // Reset form
            document.getElementById('incomeCash').value = '';
            document.getElementById('incomeBank').value = '';
            document.getElementById('incomeDescription').value = '';
        }

        function showInitialBalanceModal() {
            document.getElementById('initialCash').value = accountBalance.cash;
            document.getElementById('initialBank').value = accountBalance.bank;
            document.getElementById('initialBalanceModal').style.display = 'flex';
        }

        function confirmInitialBalance() {
            const cashAmount = parseFloat(document.getElementById('initialCash').value) || 0;
            const bankAmount = parseFloat(document.getElementById('initialBank').value) || 0;
            
            if (confirm('Sei sicuro di voler impostare il saldo iniziale? Questa operazione sovrascriver√† i saldi attuali.')) {
                accountBalance.cash = cashAmount;
                accountBalance.bank = bankAmount;
                
                // Registra transazione
                transactions.push({
                    id: Date.now(),
                    date: new Date().toISOString(),
                    type: 'initial',
                    description: 'Impostazione saldo iniziale',
                    cash: cashAmount,
                    bank: bankAmount,
                    total: cashAmount + bankAmount
                });
                
                saveData();
                updateAccountDisplay();
                closeModal('initialBalanceModal');
            }
        }

        function deleteTransaction(transactionId) {
            const transactionIndex = transactions.findIndex(t => t.id === transactionId);
            if (transactionIndex === -1) return;
            
            const transaction = transactions[transactionIndex];
            
            if (confirm('Sei sicuro di voler eliminare questo movimento?')) {
                // Ripristina i saldi
                if (transaction.type === 'income' || transaction.type === 'initial') {
                    accountBalance.cash -= transaction.cash;
                    accountBalance.bank -= transaction.bank;
                } else if (transaction.type === 'payment') {
                    accountBalance.cash += transaction.cash;
                    accountBalance.bank += transaction.bank;
                }
                
                // Rimuovi la transazione
                transactions.splice(transactionIndex, 1);
                
                saveData();
                updateAccountDisplay();
                showTransactionHistory(); // Ricarica la vista
            }
        }

        function showTransactionHistory() {
            const modal = document.getElementById('transactionModal');
            const content = document.getElementById('transactionContent');
            
            if (transactions.length === 0) {
                content.innerHTML = '<p style="text-align: center; color: #888;">Nessuna transazione registrata</p>';
            } else {
                const sortedTransactions = [...transactions].reverse();
                content.innerHTML = `
                    <div class="transaction-history">
                        ${sortedTransactions.map(t => {
                            const date = new Date(t.date);
                            const dateStr = date.toLocaleDateString('it-IT') + ' ' + date.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                            const isIncome = t.type === 'income' || t.type === 'initial';
                            const icon = t.type === 'income' ? '‚ûï' : t.type === 'payment' ? '‚ûñ' : '‚öôÔ∏è';
                            
                            return `
                                <div class="transaction-item">
                                    <div>
                                        <div>${icon} ${t.description}</div>
                                        <div class="transaction-date">${dateStr}</div>
                                        ${t.cash > 0 ? `<div style="color: #888; font-size: 0.9em;">üíµ ‚Ç¨${t.cash.toFixed(2)}</div>` : ''}
                                        ${t.bank > 0 ? `<div style="color: #888; font-size: 0.9em;">üè¶ ‚Ç¨${t.bank.toFixed(2)}</div>` : ''}
                                    </div>
                                    <div class="transaction-actions">
                                        <div class="transaction-amount ${isIncome ? 'positive' : 'negative'}">
                                            ${isIncome ? '+' : '-'}‚Ç¨ ${Math.abs(t.total).toFixed(2)}
                                        </div>
                                        <button class="btn btn-danger" onclick="deleteTransaction(${t.id})">
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            modal.style.display = 'flex';
        }

        function toggleExpensePayment(weekId, category, paymentType, isCustom) {
            const key = `${weekId}-${isCustom ? 'custom-' : ''}${category}-${paymentType}`;
            const isChecked = !expensePaymentStatus[key];
            expensePaymentStatus[key] = isChecked;
            
            // Trova la settimana e l'importo
            const week = weeksData.find(w => w.id === weekId);
            if (week) {
                const expenses = isCustom ? week.customExpenses : week.expenses;
                const amount = expenses[category][paymentType];
                
                if (amount > 0) {
                    if (isChecked) {
                        // Sottrai dal conto quando viene pagato
                        if (paymentType === 'cash') {
                            accountBalance.cash -= amount;
                        } else {
                            accountBalance.bank -= amount;
                        }
                        
                        // Registra transazione
                        transactions.push({
                            id: Date.now(),
                            date: new Date().toISOString(),
                            type: 'payment',
                            description: `Pagamento ${category} - ${week.date}`,
                            cash: paymentType === 'cash' ? amount : 0,
                            bank: paymentType === 'bank' ? amount : 0,
                            total: amount
                        });
                    } else {
                        // Riaggiungi al conto se viene deselezionato
                        if (paymentType === 'cash') {
                            accountBalance.cash += amount;
                        } else {
                            accountBalance.bank += amount;
                        }
                        
                        // Registra transazione di storno
                        transactions.push({
                            id: Date.now(),
                            date: new Date().toISOString(),
                            type: 'income',
                            description: `Storno pagamento ${category} - ${week.date}`,
                            cash: paymentType === 'cash' ? amount : 0,
                            bank: paymentType === 'bank' ? amount : 0,
                            total: amount
                        });
                    }
                }
            }
            
            saveData();
            updateAccountDisplay();
            renderWeeks();
        }

        function togglePaymentStatus(paymentKey, isChecked) {
            paymentStatus[paymentKey] = isChecked;
            
            // Trova il pagamento corrispondente
            const parts = paymentKey.split('-');
            const weekId = parseInt(parts[0]);
            const isCustom = paymentKey.includes('-custom');
            
            let category, paymentType;
            if (isCustom) {
                // Format: weekId-category-cash-custom
                category = parts.slice(1, -2).join('-');
                paymentType = parts[parts.length - 2];
            } else {
                // Format: weekId-category-cash
                category = parts.slice(1, -1).join('-');
                paymentType = parts[parts.length - 1];
            }
            
            // Trova la settimana negli archivi
            const week = archivedWeeks.find(w => w.id === weekId);
            if (week) {
                const expenses = isCustom ? week.customExpenses : week.expenses;
                const data = expenses[category];
                if (data) {
                    const amount = data[paymentType] || 0;
                    
                    if (amount > 0) {
                        if (isChecked) {
                            // Sottrai dal conto quando viene pagato
                            if (paymentType === 'cash') {
                                accountBalance.cash -= amount;
                            } else {
                                accountBalance.bank -= amount;
                            }
                            
                            // Registra transazione
                            transactions.push({
                                id: Date.now(),
                                date: new Date().toISOString(),
                                type: 'payment',
                                description: `Pagamento ${category} - ${week.date} (Archiviato)`,
                                cash: paymentType === 'cash' ? amount : 0,
                                bank: paymentType === 'bank' ? amount : 0,
                                total: amount
                            });
                        } else {
                            // Riaggiungi al conto se viene deselezionato
                            if (paymentType === 'cash') {
                                accountBalance.cash += amount;
                            } else {
                                accountBalance.bank += amount;
                            }
                            
                            // Registra transazione di storno
                            transactions.push({
                                id: Date.now(),
                                date: new Date().toISOString(),
                                type: 'income',
                                description: `Storno pagamento ${category} - ${week.date} (Archiviato)`,
                                cash: paymentType === 'cash' ? amount : 0,
                                bank: paymentType === 'bank' ? amount : 0,
                                total: amount
                            });
                        }
                    }
                }
            }
            
            saveData();
            updateAccountDisplay();
            renderPaymentsTracker();
        }

        function showAddWeekModal() {
            document.getElementById('addWeekModal').style.display = 'flex';
        }

        function confirmAddWeek() {
            const weekNum = document.getElementById('weekNumber').value;
            const month = parseInt(document.getElementById('monthSelect').value);
            const year = document.getElementById('yearSelect').value;
            const monthNames = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
                              'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
            
            const newWeek = {
                id: ++weekIdCounter,
                date: `Settimana ${weekNum} - ${monthNames[month]} ${year}`,
                expenses: {},
                customExpenses: {},
                total: 0,
                cashTotal: 0,
                bankTotal: 0,
                archived: false
            };

            defaultCategories.forEach(cat => {
                newWeek.expenses[cat] = { cash: 0, bank: 0 };
            });

            weeksData.unshift(newWeek);
            saveData();
            renderWeeks();
            closeModal('addWeekModal');
        }

        function calculateWeekTotals(week) {
            week.total = 0;
            week.cashTotal = 0;
            week.bankTotal = 0;

            // Calcola spese predefinite
            Object.entries(week.expenses).forEach(([cat, data]) => {
                const cashAmount = data.cash || 0;
                const bankAmount = data.bank || 0;
                week.total += cashAmount + bankAmount;
                week.cashTotal += cashAmount;
                week.bankTotal += bankAmount;
            });

            // Calcola spese personalizzate
            Object.entries(week.customExpenses).forEach(([cat, data]) => {
                const cashAmount = data.cash || 0;
                const bankAmount = data.bank || 0;
                week.total += cashAmount + bankAmount;
                week.cashTotal += cashAmount;
                week.bankTotal += bankAmount;
            });
        }

        function renderWeeks() {
            const container = document.getElementById('weeksContainer');
            container.innerHTML = '';

            const activeWeeks = weeksData.filter(week => !week.archived);
            activeWeeks.forEach(week => {
                const weekCard = createWeekCard(week);
                container.appendChild(weekCard);
            });
        }

        function renderArchivedWeeks() {
            const container = document.getElementById('archivedWeeksContainer');
            const section = document.getElementById('archiveSection');
            
            if (archivedWeeks.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            container.innerHTML = '';

            archivedWeeks.forEach(week => {
                const card = document.createElement('div');
                card.className = 'archived-week-card';
                card.innerHTML = `
                    <h4 style="color: #6c5ce7; margin-bottom: 10px;">${week.date}</h4>
                    <div style="font-size: 1.2em; font-weight: bold; color: #ff6b6b;">‚Ç¨ ${week.total.toFixed(2)}</div>
                    <div style="font-size: 0.9em; color: #888; margin-top: 5px;">
                        üíµ ‚Ç¨${week.cashTotal.toFixed(2)} | üè¶ ‚Ç¨${week.bankTotal.toFixed(2)}
                    </div>
                    <button class="btn btn-secondary" style="margin-top: 10px; width: 100%;" 
                            onclick="reopenWeek(${week.id})">
                        üìÇ Riapri
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function renderPaymentsTracker() {
            const container = document.getElementById('paymentsTrackerContainer');
            const section = document.getElementById('paymentsTrackerSection');
            
            // Raccogli tutti i pagamenti dalle settimane archiviate
            const allPayments = [];
            
            archivedWeeks.forEach(week => {
                Object.entries(week.expenses).forEach(([cat, data]) => {
                    if (data.cash > 0) {
                        allPayments.push({
                            weekId: week.id,
                            weekDate: week.date,
                            category: cat,
                            amount: data.cash,
                            type: 'cash',
                            key: `${week.id}-${cat}-cash`
                        });
                    }
                    if (data.bank > 0) {
                        allPayments.push({
                            weekId: week.id,
                            weekDate: week.date,
                            category: cat,
                            amount: data.bank,
                            type: 'bank',
                            key: `${week.id}-${cat}-bank`
                        });
                    }
                });
                
                Object.entries(week.customExpenses).forEach(([cat, data]) => {
                    if (data.cash > 0) {
                        allPayments.push({
                            weekId: week.id,
                            weekDate: week.date,
                            category: cat,
                            amount: data.cash,
                            type: 'cash',
                            key: `${week.id}-${cat}-cash-custom`
                        });
                    }
                    if (data.bank > 0) {
                        allPayments.push({
                            weekId: week.id,
                            weekDate: week.date,
                            category: cat,
                            amount: data.bank,
                            type: 'bank',
                            key: `${week.id}-${cat}-bank-custom`
                        });
                    }
                });
            });

            if (allPayments.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            container.innerHTML = '';

            // Ordina per settimana e categoria
            allPayments.sort((a, b) => b.weekId - a.weekId);

            allPayments.forEach(payment => {
                const isCompleted = paymentStatus[payment.key] || false;
                const item = document.createElement('div');
                item.className = `payment-track-item ${isCompleted ? 'completed' : ''}`;
                
                item.innerHTML = `
                    <div class="payment-track-info">
                        <div class="payment-track-category">${payment.category}</div>
                        <div class="payment-track-details">
                            ${payment.weekDate} | 
                            ${payment.type === 'cash' ? 'üíµ Contanti' : 'üè¶ Bonifico'} | 
                            ‚Ç¨${payment.amount.toFixed(2)}
                        </div>
                    </div>
                    <input type="checkbox" 
                           class="payment-checkbox" 
                           ${isCompleted ? 'checked' : ''}
                           onchange="togglePaymentStatus('${payment.key}', this.checked)">
                `;
                
                container.appendChild(item);
            });
        }

        function createWeekCard(week) {
            const card = document.createElement('div');
            card.className = week.archived ? 'week-card archived' : 'week-card';
            card.id = `week-${week.id}`;

            const header = document.createElement('div');
            header.className = 'week-header';
            header.innerHTML = `
                <h3 class="week-date">
                    ${week.date}
                    ${week.archived ? '<span class="archived-badge">Archiviata</span>' : ''}
                </h3>
                <div>
                    <button class="btn btn-archive" onclick="archiveWeek(${week.id})">
                        üìÅ Archivia
                    </button>
                    <button class="btn btn-secondary" onclick="exportWeekToPDF(${week.id})">
                        üìÑ PDF
                    </button>
                    <button class="btn btn-secondary" onclick="deleteWeek(${week.id})">
                        üóëÔ∏è Elimina
                    </button>
                </div>
            `;
            card.appendChild(header);

            const expenseGrid = document.createElement('div');
            expenseGrid.className = 'expense-grid';

            // Spese predefinite
            for (const [category, data] of Object.entries(week.expenses)) {
                const item = createExpenseItem(week.id, category, data, false);
                expenseGrid.appendChild(item);
            }

            // Spese personalizzate
            for (const [category, data] of Object.entries(week.customExpenses)) {
                const item = createExpenseItem(week.id, category, data, true);
                expenseGrid.appendChild(item);
            }

            card.appendChild(expenseGrid);

            // Sezione per aggiungere spese personalizzate
            const customSection = document.createElement('div');
            customSection.className = 'custom-expense';
            customSection.innerHTML = `
                <input type="text" id="customName-${week.id}" placeholder="Nome nuova spesa...">
                <button class="btn btn-primary" onclick="addCustomExpense(${week.id})">
                    ‚ûï Aggiungi Voce
                </button>
            `;
            card.appendChild(customSection);

            // Totale con dettagli pagamento
            const totalSection = document.createElement('div');
            totalSection.className = 'total-section';
            totalSection.innerHTML = `
                <div>TOTALE SETTIMANA</div>
                <div class="total-amount">‚Ç¨ ${week.total.toFixed(2)}</div>
                <div class="payment-totals">
                    <div class="payment-total-item">
                        <div class="payment-total-label">üíµ Contanti</div>
                        <div class="payment-total-value">‚Ç¨ ${week.cashTotal.toFixed(2)}</div>
                    </div>
                    <div class="payment-total-item">
                        <div class="payment-total-label">üè¶ Bonifico</div>
                        <div class="payment-total-value">‚Ç¨ ${week.bankTotal.toFixed(2)}</div>
                    </div>
                </div>
            `;
            card.appendChild(totalSection);

            return card;
        }

        function createExpenseItem(weekId, category, data, isCustom) {
            const item = document.createElement('div');
            item.className = 'expense-item';
            
            const cashAmount = data.cash || 0;
            const bankAmount = data.bank || 0;
            const baseName = isCustom ? `custom-${weekId}-${category}` : `expense-${weekId}-${category}`;
            
            const cashKey = `${weekId}-${isCustom ? 'custom-' : ''}${category}-cash`;
            const bankKey = `${weekId}-${isCustom ? 'custom-' : ''}${category}-bank`;
            
            const isCashPaid = expensePaymentStatus[cashKey] || false;
            const isBankPaid = expensePaymentStatus[bankKey] || false;
            
            item.innerHTML = `
                <label class="expense-label">${category}</label>
                <div class="expense-inputs">
                    <div class="input-group">
                        <span class="payment-label">üíµ Contanti</span>
                        <span>‚Ç¨</span>
                        <input type="number" 
                               id="cash-${baseName}"
                               class="expense-input ${isCashPaid ? 'paid' : ''}" 
                               value="${cashAmount || ''}" 
                               onchange="updateExpense(${weekId}, '${category}', 'cash', this.value, ${isCustom})">
                        ${cashAmount > 0 ? `
                            <input type="checkbox" 
                                   style="margin-left: 5px;"
                                   ${isCashPaid ? 'checked' : ''}
                                   onchange="toggleExpensePayment(${weekId}, '${category}', 'cash', ${isCustom})"
                                   title="Segna come pagato">
                        ` : ''}
                    </div>
                    <div class="input-group">
                        <span class="payment-label">üè¶ Bonifico</span>
                        <span>‚Ç¨</span>
                        <input type="number" 
                               id="bank-${baseName}"
                               class="expense-input ${isBankPaid ? 'paid' : ''}" 
                               value="${bankAmount || ''}" 
                               onchange="updateExpense(${weekId}, '${category}', 'bank', this.value, ${isCustom})">
                        ${bankAmount > 0 ? `
                            <input type="checkbox" 
                                   style="margin-left: 5px;"
                                   ${isBankPaid ? 'checked' : ''}
                                   onchange="toggleExpensePayment(${weekId}, '${category}', 'bank', ${isCustom})"
                                   title="Segna come pagato">
                        ` : ''}
                    </div>
                </div>
                ${isCustom ? `<button onclick="removeCustomExpense(${weekId}, '${category}')" style="background: none; border: none; color: #ff6b6b; cursor: pointer; margin-top: 10px; width: 100%; text-align: center;">‚ùå Rimuovi</button>` : ''}
            `;
            
            return item;
        }

        function updateExpense(weekId, category, paymentType, value, isCustom) {
            const week = weeksData.find(w => w.id === weekId);
            if (!week) return;

            const amount = parseFloat(value) || 0;
            
            if (isCustom) {
                if (!week.customExpenses[category]) {
                    week.customExpenses[category] = { cash: 0, bank: 0 };
                }
                week.customExpenses[category][paymentType] = amount;
            } else {
                week.expenses[category][paymentType] = amount;
            }

            calculateWeekTotals(week);
            updateWeekTotals(weekId, week);
            saveData();
            updateAccountDisplay();
        }

        function updateWeekTotals(weekId, week) {
            const totalElement = document.querySelector(`#week-${weekId} .total-amount`);
            const cashElement = document.querySelector(`#week-${weekId} .payment-totals .payment-total-value`);
            const bankElement = document.querySelectorAll(`#week-${weekId} .payment-totals .payment-total-value`)[1];
            
            if (totalElement) totalElement.textContent = `‚Ç¨ ${week.total.toFixed(2)}`;
            if (cashElement) cashElement.textContent = `‚Ç¨ ${week.cashTotal.toFixed(2)}`;
            if (bankElement) bankElement.textContent = `‚Ç¨ ${week.bankTotal.toFixed(2)}`;
        }

        function addCustomExpense(weekId) {
            const nameInput = document.getElementById(`customName-${weekId}`);
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Inserisci un nome per la spesa!');
                return;
            }

            const week = weeksData.find(w => w.id === weekId);
            if (!week) return;

            week.customExpenses[name] = { cash: 0, bank: 0 };

            saveData();
            renderWeeks();
        }

        function removeCustomExpense(weekId, category) {
            const week = weeksData.find(w => w.id === weekId);
            if (!week) return;

            delete week.customExpenses[category];
            calculateWeekTotals(week);
            saveData();
            renderWeeks();
        }

        function archiveWeek(weekId) {
            const weekIndex = weeksData.findIndex(w => w.id === weekId);
            if (weekIndex === -1) return;

            const week = weeksData[weekIndex];
            week.archived = true;
            
            // Sposta dalla lista attiva a quella archiviata
            weeksData.splice(weekIndex, 1);
            archivedWeeks.unshift(week);
            
            saveData();
            renderWeeks();
            renderArchivedWeeks();
            renderPaymentsTracker();
            updateAccountDisplay();
        }

        function reopenWeek(weekId) {
            const archivedIndex = archivedWeeks.findIndex(w => w.id === weekId);
            if (archivedIndex === -1) return;

            const week = archivedWeeks[archivedIndex];
            week.archived = false;
            
            // Sposta dalla lista archiviata a quella attiva
            archivedWeeks.splice(archivedIndex, 1);
            weeksData.unshift(week);
            
            saveData();
            renderWeeks();
            renderArchivedWeeks();
            renderPaymentsTracker();
        }

        function deleteWeek(weekId) {
            if (confirm('Sei sicuro di voler eliminare questa settimana?')) {
                weeksData = weeksData.filter(w => w.id !== weekId);
                archivedWeeks = archivedWeeks.filter(w => w.id !== weekId);
                
                // Rimuovi anche i pagamenti correlati
                Object.keys(paymentStatus).forEach(key => {
                    if (key.startsWith(`${weekId}-`)) {
                        delete paymentStatus[key];
                    }
                });
                
                Object.keys(expensePaymentStatus).forEach(key => {
                    if (key.startsWith(`${weekId}-`)) {
                        delete expensePaymentStatus[key];
                    }
                });
                
                saveData();
                renderWeeks();
                renderArchivedWeeks();
                renderPaymentsTracker();
                updateAccountDisplay();
            }
        }

        function showStatistics() {
            const allWeeks = [...weeksData, ...archivedWeeks];
            
            if (allWeeks.length < 2) {
                alert('Servono almeno 2 settimane per vedere le statistiche!');
                return;
            }

            const modal = document.getElementById('statsModal');
            const content = document.getElementById('statsContent');
            
            const totalExpenses = allWeeks.reduce((sum, week) => sum + week.total, 0);
            const totalCash = allWeeks.reduce((sum, week) => sum + week.cashTotal, 0);
            const totalBank = allWeeks.reduce((sum, week) => sum + week.bankTotal, 0);
            const avgWeekly = totalExpenses / allWeeks.length;
            const maxWeek = allWeeks.reduce((max, week) => week.total > max.total ? week : max);
            const minWeek = allWeeks.reduce((min, week) => week.total < min.total ? week : min);

            // Calcola pagamenti completati
            const completedPayments = Object.values(paymentStatus).filter(status => status).length;
            const totalPayments = Object.keys(paymentStatus).length;
            const completionRate = totalPayments > 0 ? (completedPayments / totalPayments * 100).toFixed(1) : 0;

            content.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title">Totale Generale</div>
                        <div class="stat-value">‚Ç¨ ${totalExpenses.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Media Settimanale</div>
                        <div class="stat-value">‚Ç¨ ${avgWeekly.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Totale Contanti</div>
                        <div class="stat-value">‚Ç¨ ${totalCash.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Totale Bonifici</div>
                        <div class="stat-value">‚Ç¨ ${totalBank.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Pagamenti Completati</div>
                        <div class="stat-value">${completionRate}%</div>
                        <div style="color: #888; font-size: 0.9em;">${completedPayments}/${totalPayments}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Settimana pi√π Costosa</div>
                        <div class="stat-value">‚Ç¨ ${maxWeek.total.toFixed(2)}</div>
                        <div style="color: #888; font-size: 0.9em;">${maxWeek.date}</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="weeklyChart"></canvas>
                </div>
                <div class="chart-container" style="margin-top: 30px;">
                    <h3 style="text-align: center; color: #fff; margin-bottom: 20px;">üìà Andamento Entrate vs Uscite</h3>
                    <canvas id="cashFlowChart"></canvas>
                </div>
            `;

            modal.style.display = 'flex';

            setTimeout(() => {
                if (charts.weekly) {
                    charts.weekly.destroy();
                }

                const ctx = document.getElementById('weeklyChart').getContext('2d');
                charts.weekly = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: allWeeks.map(w => w.date).reverse(),
                        datasets: [{
                            label: 'Spese Totali',
                            data: allWeeks.map(w => w.total).reverse(),
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Contanti',
                            data: allWeeks.map(w => w.cashTotal).reverse(),
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Bonifici',
                            data: allWeeks.map(w => w.bankTotal).reverse(),
                            borderColor: '#45b7d1',
                            backgroundColor: 'rgba(69, 183, 209, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#fff' }
                            }
                        },
                        scales: {
                            y: {
                                ticks: { color: '#fff' },
                                grid: { color: '#333' }
                            },
                            x: {
                                ticks: { color: '#fff' },
                                grid: { color: '#333' }
                            }
                        }
                    }
                });

                // Crea grafico andamento entrate vs uscite
                if (charts.cashFlow) {
                    charts.cashFlow.destroy();
                }

                // Raggruppa transazioni per mese
                const monthlyData = {};
                transactions.forEach(t => {
                    const date = new Date(t.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { income: 0, expenses: 0 };
                    }
                    
                    if (t.type === 'income' || t.type === 'initial') {
                        monthlyData[monthKey].income += t.total;
                    } else if (t.type === 'payment') {
                        monthlyData[monthKey].expenses += t.total;
                    }
                });

                const sortedMonths = Object.keys(monthlyData).sort();
                const monthLabels = sortedMonths.map(key => {
                    const [year, month] = key.split('-');
                    const monthNames = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'];
                    return `${monthNames[parseInt(month) - 1]} ${year}`;
                });

                const ctxFlow = document.getElementById('cashFlowChart').getContext('2d');
                charts.cashFlow = new Chart(ctxFlow, {
                    type: 'line',
                    data: {
                        labels: monthLabels,
                        datasets: [{
                            label: 'Entrate',
                            data: sortedMonths.map(month => monthlyData[month].income),
                            borderColor: '#2ecc71',
                            backgroundColor: 'rgba(46, 204, 113, 0.1)',
                            tension: 0.4,
                            borderWidth: 3
                        }, {
                            label: 'Uscite',
                            data: sortedMonths.map(month => monthlyData[month].expenses),
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4,
                            borderWidth: 3
                        }, {
                            label: 'Saldo',
                            data: sortedMonths.map(month => monthlyData[month].income - monthlyData[month].expenses),
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            tension: 0.4,
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#fff' }
                            }
                        },
                        scales: {
                            y: {
                                ticks: { color: '#fff' },
                                grid: { color: '#333' }
                            },
                            x: {
                                ticks: { color: '#fff' },
                                grid: { color: '#333' }
                            }
                        }
                    }
                });
            }, 100);
        }

        function showCategoryAnalysis() {
            const allWeeks = [...weeksData, ...archivedWeeks];
            const modal = document.getElementById('categoryModal');
            const content = document.getElementById('categoryContent');
            
            // Calcola totali per categoria
            const categoryTotals = {};
            
            allWeeks.forEach(week => {
                Object.entries(week.expenses).forEach(([cat, data]) => {
                    const total = (data.cash || 0) + (data.bank || 0);
                    categoryTotals[cat] = (categoryTotals[cat] || 0) + total;
                });
                Object.entries(week.customExpenses).forEach(([cat, data]) => {
                    const total = (data.cash || 0) + (data.bank || 0);
                    categoryTotals[cat] = (categoryTotals[cat] || 0) + total;
                });
            });

            // Ordina per importo
            const sortedCategories = Object.entries(categoryTotals)
                .sort((a, b) => b[1] - a[1])
                .filter(([_, amount]) => amount > 0);

            content.innerHTML = `
                <div class="stats-grid">
                    ${sortedCategories.slice(0, 6).map(([cat, amount]) => `
                        <div class="stat-card">
                            <div class="stat-title">${cat}</div>
                            <div class="stat-value">‚Ç¨ ${amount.toFixed(2)}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            `;

            modal.style.display = 'flex';

            // Crea grafico a torta
            setTimeout(() => {
                if (charts.category) {
                    charts.category.destroy();
                }

                const ctx = document.getElementById('categoryChart').getContext('2d');
                charts.category = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: sortedCategories.map(([cat]) => cat),
                        datasets: [{
                            data: sortedCategories.map(([_, amount]) => amount),
                            backgroundColor: [
                                '#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24',
                                '#6c5ce7', '#a29bfe', '#fd79a8', '#fdcb6e',
                                '#e17055', '#00b894', '#00cec9', '#0984e3'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { color: '#fff' }
                            }
                        }
                    }
                });
            }, 100);
        }

        function showPaymentMethodStats() {
            const allWeeks = [...weeksData, ...archivedWeeks];
            const modal = document.getElementById('paymentModal');
            const content = document.getElementById('paymentContent');
            
            // Calcola totali per metodo di pagamento per categoria
            const paymentByCategory = {};
            
            allWeeks.forEach(week => {
                Object.entries(week.expenses).forEach(([cat, data]) => {
                    if (!paymentByCategory[cat]) {
                        paymentByCategory[cat] = { cash: 0, bank: 0 };
                    }
                    paymentByCategory[cat].cash += data.cash || 0;
                    paymentByCategory[cat].bank += data.bank || 0;
                });
                
                Object.entries(week.customExpenses).forEach(([cat, data]) => {
                    if (!paymentByCategory[cat]) {
                        paymentByCategory[cat] = { cash: 0, bank: 0 };
                    }
                    paymentByCategory[cat].cash += data.cash || 0;
                    paymentByCategory[cat].bank += data.bank || 0;
                });
            });

            const totalCash = allWeeks.reduce((sum, week) => sum + week.cashTotal, 0);
            const totalBank = allWeeks.reduce((sum, week) => sum + week.bankTotal, 0);
            const total = totalCash + totalBank;

            content.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title">Percentuale Contanti</div>
                        <div class="stat-value">${total > 0 ? ((totalCash / total) * 100).toFixed(1) : 0}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Percentuale Bonifici</div>
                        <div class="stat-value">${total > 0 ? ((totalBank / total) * 100).toFixed(1) : 0}%</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="paymentPieChart"></canvas>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="paymentBarChart"></canvas>
                    </div>
                </div>
                <h3 style="margin: 20px 0; color: #ff6b6b;">Dettaglio per Categoria</h3>
                <div class="stats-grid">
                    ${Object.entries(paymentByCategory)
                        .filter(([_, data]) => (data.cash + data.bank) > 0)
                        .sort((a, b) => (b[1].cash + b[1].bank) - (a[1].cash + a[1].bank))
                        .slice(0, 6)
                        .map(([cat, data]) => `
                            <div class="stat-card">
                                <div class="stat-title">${cat}</div>
                                <div style="display: flex; justify-content: space-around; margin-top: 10px;">
                                    <div>
                                        <div style="color: #4ecdc4; font-size: 0.9em;">üíµ Contanti</div>
                                        <div style="font-weight: bold;">‚Ç¨ ${data.cash.toFixed(2)}</div>
                                    </div>
                                    <div>
                                        <div style="color: #45b7d1; font-size: 0.9em;">üè¶ Bonifico</div>
                                        <div style="font-weight: bold;">‚Ç¨ ${data.bank.toFixed(2)}</div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                </div>
            `;

            modal.style.display = 'flex';

            // Crea grafici
            setTimeout(() => {
                // Grafico a torta
                if (charts.paymentPie) {
                    charts.paymentPie.destroy();
                }
                const ctxPie = document.getElementById('paymentPieChart').getContext('2d');
                charts.paymentPie = new Chart(ctxPie, {
                    type: 'pie',
                    data: {
                        labels: ['Contanti', 'Bonifici'],
                        datasets: [{
                            data: [totalCash, totalBank],
                            backgroundColor: ['#4ecdc4', '#45b7d1']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#fff' }
                            },
                            title: {
                                display: true,
                                text: 'Distribuzione Totale',
                                color: '#fff'
                            }
                        }
                    }
                });

                // Grafico a barre per categorie principali
                if (charts.paymentBar) {
                    charts.paymentBar.destroy();
                }
                const topCategories = Object.entries(paymentByCategory)
                    .filter(([_, data]) => (data.cash + data.bank) > 0)
                    .sort((a, b) => (b[1].cash + b[1].bank) - (a[1].cash + a[1].bank))
                    .slice(0, 5);

                const ctxBar = document.getElementById('paymentBarChart').getContext('2d');
                charts.paymentBar = new Chart(ctxBar, {
                    type: 'bar',
                    data: {
                        labels: topCategories.map(([cat]) => cat),
                        datasets: [{
                            label: 'Contanti',
                            data: topCategories.map(([_, data]) => data.cash),
                            backgroundColor: '#4ecdc4'
                        }, {
                            label: 'Bonifici',
                            data: topCategories.map(([_, data]) => data.bank),
                            backgroundColor: '#45b7d1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#fff' }
                            },
                            title: {
                                display: true,
                                text: 'Top 5 Categorie',
                                color: '#fff'
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                ticks: { color: '#fff' },
                                grid: { color: '#333' }
                            },
                            y: {
                                stacked: true,
                                ticks: { color: '#fff' },
                                grid: { color: '#333' }
                            }
                        }
                    }
                });
            }, 100);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function exportWeekToPDF(weekId) {
            const week = [...weeksData, ...archivedWeeks].find(w => w.id === weekId);
            if (!week) return;

            const element = document.getElementById(`week-${weekId}`);
            const opt = {
                margin: 10,
                filename: `Pagamenti_${week.date.replace(/\s/g, '_')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save();
        }

        function exportAllToPDF() {
            const content = document.createElement('div');
            content.style.padding = '20px';
            content.innerHTML = `
                <h1 style="text-align: center; margin-bottom: 30px;">PAGAMENTI TOTALI PAPI üòàüí∞</h1>
                <h2 style="text-align: center; margin-bottom: 20px;">Report Completo</h2>
            `;

            // Aggiungi settimane attive
            if (weeksData.length > 0) {
                const activeTitle = document.createElement('h3');
                activeTitle.textContent = 'Settimane Attive';
                activeTitle.style.marginTop = '30px';
                activeTitle.style.marginBottom = '20px';
                content.appendChild(activeTitle);

                weeksData.forEach(week => {
                    const weekClone = createWeekCard(week);
                    weekClone.querySelectorAll('button').forEach(btn => btn.remove());
                    content.appendChild(weekClone);
                });
            }

            // Aggiungi settimane archiviate
            if (archivedWeeks.length > 0) {
                const archivedTitle = document.createElement('h3');
                archivedTitle.textContent = 'Settimane Archiviate';
                archivedTitle.style.marginTop = '30px';
                archivedTitle.style.marginBottom = '20px';
                archivedTitle.style.color = '#6c5ce7';
                content.appendChild(archivedTitle);

                archivedWeeks.forEach(week => {
                    const weekClone = createWeekCard(week);
                    weekClone.querySelectorAll('button').forEach(btn => btn.remove());
                    content.appendChild(weekClone);
                });
            }

            const opt = {
                margin: 10,
                filename: 'Pagamenti_Totali_Papi_Report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(content).save();
        }

        // Chiudi modal cliccando fuori
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
